<%- include('layout', {
    pageTitle: 'Depurador de Estado',
    activeTab: 'debug',
    username: username,
    showMessages: true,
    body: `
        <style>
            body, .container, .row, .card, .card-header, .card-body, .breadcrumb, .preview-box {
                background: var(--bg-primary, #181c24) !important;
                color: var(--text-primary, #f1f1f1) !important;
            }
            .card {
                background: var(--card-bg, #232836) !important;
                color: var(--text-primary, #f1f1f1) !important;
                border: none;
                box-shadow: 0 0.15rem 1.75rem 0 #10131a99;
            }
            .card-header {
                background: var(--bg-secondary, #232836) !important;
                color: var(--accent-color, #25D366) !important;
                border-bottom: 1px solid var(--border-color, #333) !important;
            }
            .breadcrumb {
                background: transparent !important;
                color: var(--text-secondary, #b0b0b0) !important;
            }
            .form-control, .input-group-text {
                background: #232836 !important;
                color: #f1f1f1 !important;
                border: 1px solid var(--border-color, #333) !important;
            }
            .form-control:focus {
                background: #232836 !important;
                color: #fff !important;
                border-color: var(--accent-color, #25D366) !important;
                box-shadow: 0 0 0 0.2rem #25d36633;
            }
            .btn-primary {
                background: var(--accent-color, #25D366) !important;
                border: none !important;
                color: #181c24 !important;
                font-weight: bold;
            }
            .btn-primary:hover {
                background: var(--highlight-color, #128C7E) !important;
                color: #fff !important;
            }
            .alert-info {
                background: #1a232d !important;
                color: #b3e6c7 !important;
                border: 1px solid #25D366 !important;
            }
        </style>
        <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="h3 mb-0 text-gray-800">Depurador de Estado de WhatsApp</h1>
            <p class="mb-0">Esta página te permite verificar el estado actual de la conexión de WhatsApp</p>
        </div>
    </div>

    <div id="messages" class="mb-4"></div>
    
    <div class="row">
        <div class="col-md-6">
            <!-- Mostrador de estado -->
            <div id="statusDisplay" class="mb-4">
                <div class="card">
                    <div class="card-body text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p>Verificando estado...</p>
                    </div>
                </div>
            </div>
            
            <!-- Información del archivo de estado -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="m-0 font-weight-bold">Información del Sistema</h5>
                </div>
                <div class="card-body">
                    <p><strong>Archivo de estado:</strong> <code>/config/whatsappStatus.json</code></p>
                    <p><strong>Archivo de QR:</strong> <code>/config/whatsappQR.txt</code></p>
                    <p><strong>Ruta de datos:</strong> <code>C:\\Users\\Crisjo Ssj\\Documents\\bot de whatsapp\\c\\config</code></p>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <!-- Acciones de WhatsApp -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="m-0 font-weight-bold">Acciones de WhatsApp</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="forceRefresh()">
                            <i class="bi bi-arrow-repeat"></i> Actualizar Estado
                        </button>
                        <button class="btn btn-warning" onclick="restartWhatsapp()">
                            <i class="bi bi-arrow-clockwise"></i> Reiniciar Cliente
                        </button>
                        <button class="btn btn-danger" onclick="logoutWhatsapp()">
                            <i class="bi bi-box-arrow-right"></i> Cerrar Sesión
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Logs en tiempo real -->
            <div class="card">
                <div class="card-header">
                    <h5 class="m-0 font-weight-bold">Consola de Depuración</h5>
                </div>
                <div class="card-body">
                    <pre id="consoleLogs" style="height: 200px; overflow-y: auto; background-color: #f8f9fa; padding: 10px; font-size: 12px;"></pre>
                </div>
                <div class="card-footer text-muted">
                    <button class="btn btn-sm btn-outline-secondary" onclick="clearConsole()">
                        <i class="bi bi-trash"></i> Limpiar Consola
                    </button>
                </div>
            </div>
        </div>
    </div>
    `,
    extraScripts: `
    <script>
        // Interceptar console.log para mostrarlos en la página
        (function() {
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            
            function addToConsole(message, type = 'log') {
                const consoleElement = document.getElementById('consoleLogs');
                if (!consoleElement) return;
                
                const timestamp = new Date().toLocaleTimeString();
                let color = '';
                
                if (type === 'error') color = 'color: red;';
                if (type === 'warn') color = 'color: orange;';
                
                const logItem = document.createElement('div');
                logItem.innerHTML = '<span style="color: #666;">[' + timestamp + ']</span> <span style="' + color + '">' + message + '</span>';
                
                consoleElement.appendChild(logItem);
                consoleElement.scrollTop = consoleElement.scrollHeight;
            }
            
            console.log = function() {
                const args = Array.prototype.slice.call(arguments);
                addToConsole(args.map(function(arg) { return typeof arg === 'object' ? JSON.stringify(arg) : arg; }).join(' '));
                originalConsoleLog.apply(console, arguments);
            };
            
            console.error = function() {
                const args = Array.prototype.slice.call(arguments);
                addToConsole(args.map(function(arg) { return typeof arg === 'object' ? JSON.stringify(arg) : arg; }).join(' '), 'error');
                originalConsoleError.apply(console, arguments);
            };
            
            console.warn = function() {
                const args = Array.prototype.slice.call(arguments);
                addToConsole(args.map(function(arg) { return typeof arg === 'object' ? JSON.stringify(arg) : arg; }).join(' '), 'warn');
                originalConsoleWarn.apply(console, arguments);
            };
        })();
        
        // Función para limpiar la consola
        function clearConsole() {
            const consoleElement = document.getElementById('consoleLogs');
            if (consoleElement) {
                consoleElement.innerHTML = '';
            }
        }
        
        // Función para cerrar sesión
        async function logoutWhatsapp() {
            if (confirm('¿Está seguro que desea cerrar la sesión de WhatsApp?')) {
                try {
                    showMessage('Cerrando sesión...');
                    await fetch('/admin/api/whatsapp/logout', { method: 'POST' })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                showMessage('Sesión cerrada correctamente');
                                setTimeout(checkStatus, 2000);
                            } else {
                                showError(data.message || 'Error al cerrar sesión');
                            }
                        });
                } catch (error) {
                    showError('Error: ' + error.message);
                }
            }
        }
    </script>
    <script src="/admin/js/status-debugger.js"></script>
    `
}) %>
